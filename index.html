<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>115å¹´åº¦å“¡å·¥åº§è«‡æœƒææ¡ˆå¹³å°</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --cream: #FFF9F0; --warm-white: #FFFCF8; --soft-orange: #FFB088; --coral: #FF8C69;
      --warm-brown: #8B6F5C; --deep-brown: #6B5344; --text: #4A403A; --border: #F0E6DC;
      --shadow-soft: 0 8px 32px rgba(139, 111, 92, 0.12);
      --radius-lg: 32px; --radius-md: 20px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Noto Sans TC', sans-serif;
      color: var(--text);
      background: var(--cream);
      line-height: 1.7;
      font-size: 18px;
    }

    /* è­¦ç¤ºç‡ˆé–ƒçˆå±¤ (ç´…è—çˆ†é–ƒ) */
    #sirenOverlay { position: fixed; inset: 0; pointer-events: none; z-index: 9999; display: none; }
    .siren-active { display: block !important; animation: sirenFlash 0.2s infinite; }
    @keyframes sirenFlash {
      0% { background: rgba(255, 0, 0, 0.35); }
      50% { background: rgba(0, 0, 255, 0.35); }
      100% { background: rgba(255, 0, 0, 0.35); }
    }

    .container { width: min(1100px, 94vw); margin: 0 auto; padding-bottom: 50px; }
    
    .topbar { position: sticky; top: 0; z-index: 100; background: rgba(255, 252, 248, 0.95); backdrop-filter: blur(15px); border-bottom: 1px solid var(--border); padding: 15px 0; }
    .inner { display: flex; align-items: center; justify-content: space-between; }
    .brand { font-weight: 700; color: var(--deep-brown); font-size: 20px; }

    /* Hero */
    .hero { margin-top: 24px; }
    .heroCard { position: relative; overflow: hidden; border-radius: var(--radius-lg); box-shadow: var(--shadow-soft); height: 480px; background: #eee; }
    .heroCard img { width: 100%; height: 100%; object-fit: cover; }
    .heroOverlay { position: absolute; inset: 0; background: linear-gradient(180deg, rgba(107, 83, 68, 0) 0%, rgba(107, 83, 68, 0.6) 100%); }
    .heroText { position: absolute; left: 0; right: 0; bottom: 40px; padding: 0 20px; display: flex; justify-content: center; }
    .heroText .title { background: rgba(255, 252, 248, 0.96); border-radius: var(--radius-md); padding: 35px 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); max-width: 900px; text-align: center; }
    .heroText h1 { font-size: 42px; color: var(--deep-brown); margin: 0; line-height: 1.3; font-weight: 700; }
    .heroText p { margin-top: 10px; color: var(--warm-brown); font-size: 20px; font-weight: 500; }

    /* Loading */
    #loadingOverlay { position: fixed; inset: 0; background: rgba(255, 252, 248, 0.95); z-index: 10000; display: none; flex-direction: column; align-items: center; justify-content: center; }
    .spinner { width: 60px; height: 60px; border: 6px solid #eee; border-top-color: var(--coral); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 25px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Form */
    .section { margin: 30px 0; padding: 50px; background: var(--warm-white); border-radius: var(--radius-lg); box-shadow: var(--shadow-soft); border: 1px solid var(--border); }
    .section-title h2 { font-size: 32px; color: var(--deep-brown); }
    label { display: block; font-weight: 700; font-size: 19px; margin: 25px 0 10px; color: var(--deep-brown); }
    .required { color: var(--coral); margin-left: 5px; }
    input, textarea { width: 100%; border: 2px solid var(--border); border-radius: 15px; padding: 18px; font-size: 18px; outline: none; background: white; font-family: inherit; }
    input:focus, textarea:focus { border-color: var(--soft-orange); box-shadow: 0 0 0 5px rgba(255, 176, 136, 0.15); }
    .radio-group { display: flex; gap: 30px; margin-top: 10px; }
    .radio-option { display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 18px; }
    #identitySection { display: block; margin-top: 15px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }

    /* AI Hint */
    .hint { margin-top: 30px; background: white; border: 4px solid var(--soft-orange); border-radius: var(--radius-md); padding: 35px; display: none; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
    .hint-title { font-size: 24px; font-weight: 700; color: #e67e22; margin-bottom: 15px; }
    .hint-text { font-size: 18px; background: #fffaf0; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 6px solid var(--soft-orange); }

    /* æ­·å²è¡¨æ ¼ (é›»è…¦ç‰ˆ) */
    .history-table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 17px; border: 1px solid var(--border); }
    .history-table th { background: var(--coral); color: white; padding: 15px; text-align: left; }
    .history-table td { padding: 15px; border-bottom: 1px solid var(--border); vertical-align: top; background: white; }

    /* æŒ‰éˆ• */
    .btn { cursor: pointer; border-radius: 60px; padding: 18px 45px; font-weight: 700; font-size: 19px; border: none; transition: 0.2s; width: 100%; font-family: inherit; }
    .btnPrimary { background: linear-gradient(135deg, var(--soft-orange), var(--coral)); color: #fff; margin-top: 40px; }
    .btnSuccess { background: #27ae60; color: white; margin-top: 15px; box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3); } /* å„ªå…ˆé¸é … */
    .btnDanger { background: #e74c3c; color: white; margin-top: 15px; }
    
    /* æœ€çµ‚ç¢ºèªå€å¡Š (åè½‰æ¬Šé‡) */
    #finalConfirmCard { 
      display: none; background: #fff; border: 5px solid #d63031; padding: 40px; border-radius: 25px; margin-top: 40px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.2); 
    }
    .btn-giveup { background: #27ae60; color: white; font-size: 22px; padding: 22px; margin-bottom: 20px; box-shadow: 0 8px 20px rgba(39, 174, 96, 0.4); transform: scale(1.05); } /* å¤§æŒ‰éˆ• */
    .btn-force { background: #95a5a6; color: white; font-size: 16px; padding: 12px; width: auto; min-width: 200px; } /* å°æŒ‰éˆ• */

    .success { display: none; text-align: center; padding: 100px 20px; background: white; border-radius: var(--radius-lg); }

    /* RWD æ‰‹æ©Ÿç‰ˆå„ªåŒ– (å¡ç‰‡å¼è¡¨æ ¼) */
    @media (max-width: 768px) {
      .heroText h1 { font-size: 28px; }
      .heroText .title { padding: 25px; width: 95%; }
      .heroCard { height: 350px; }
      .form-row { grid-template-columns: 1fr; }
      .section { padding: 30px; }
      
      /* è¡¨æ ¼è®Šå¡ç‰‡ */
      .history-table, .history-table tbody, .history-table tr, .history-table td { display: block; width: 100%; }
      .history-table thead { display: none; } /* éš±è—è¡¨é ­ */
      .history-table tr { margin-bottom: 20px; border: 2px solid var(--border); border-radius: 15px; padding: 15px; background: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
      .history-table td { padding: 8px 0; border: none; font-size: 16px; line-height: 1.6; text-align: left; }
      /* å½å…ƒç´ åŠ æ¨™é¡Œ */
      .history-table td:nth-child(1)::before { content: "ğŸ“… æœƒè­°æ—¥æœŸï¼š"; font-weight: 700; color: var(--coral); display: inline-block; width: 100px; }
      .history-table td:nth-child(2)::before { content: "ğŸ’¬ è¨´æ±‚æ‘˜è¦ï¼š"; font-weight: 700; color: var(--deep-brown); display: block; margin-bottom: 5px; }
      .history-table td:nth-child(3)::before { content: "âœ… è¾¦ç†çµæœï¼š"; font-weight: 700; color: var(--deep-brown); display: block; margin-top: 10px; margin-bottom: 5px; }
    }
  </style>
</head>
<body>
  <!-- è®€å–é®ç½© -->
  <div id="loadingOverlay">
    <div class="spinner"></div>
    <div style="font-weight:700; font-size:20px; color:var(--deep-brown); text-align:center; padding:0 20px;">è«‹ç¨å€™ï¼Œæ­£åœ¨åˆ†ææ­·æ¬¡åº§è«‡æœƒçš„æ”¿ç­–æ¼”é€²...</div>
  </div>

  <div id="sirenOverlay"></div>

  <div class="topbar"><div class="container"><div class="inner"><div class="brand">ğŸ’¬ å“¡å·¥åº§è«‡æœƒæ„è¦‹å¹³å°</div><div id="today" style="font-weight:700;"></div></div></div></div>

  <main class="container">
    <section class="hero">
      <figure class="heroCard">
        <img src="./1770205128981.jpg" alt="Hero"/>
        <div class="heroOverlay"></div>
        <div class="heroText">
          <div class="title">
            <h1>æ¯ä¸€ä»½å»ºè­°ï¼Œéƒ½æ˜¯æˆé•·çš„åŠ›é‡</h1>
            <p>é€éæ‚¨çš„è²éŸ³ï¼Œè®“æˆ‘å€‘ä¸€èµ·å»ºè¨­æ›´ç¾å¥½çš„å·¥ä½œç’°å¢ƒ ğŸ’ª</p>
          </div>
        </div>
      </figure>
    </section>

    <section class="section" id="formSection">
      <div class="section-title"><h2>å¡«å¯«æ‚¨çš„ææ¡ˆ</h2><p style="color:var(--warm-brown); margin-top:5px;">ğŸ’¡ ç³»çµ±å°‡è‡ªå‹•æ¯”å°æ­·å¹´ç›¸ä¼¼æ¡ˆä»¶</p></div>
      
      <label>1. è«‹å•ææ¡ˆæ˜¯å¦å…·åï¼Ÿ <span class="required">*</span></label>
      <div class="radio-group">
        <label style="cursor:pointer;"><input type="radio" name="identity" value="named" checked onclick="toggleId(true)"> è¨˜ååæ˜ </label>
        <label style="cursor:pointer;"><input type="radio" name="identity" value="anon" onclick="toggleId(false)"> ä¸è¨˜ååæ˜ </label>
      </div>

      <div id="identitySection">
        <label>å–®ä½ / è·ç¨± / å§“å <span class="required">*</span></label>
        <div class="form-row">
          <input type="text" id="dept" placeholder="å–®ä½">
          <input type="text" id="jobTitle" placeholder="è·ç¨±">
          <input type="text" id="userName" placeholder="å§“å">
        </div>
      </div>

      <label>5. å»ºè­°äº‹é … <span class="required">*</span></label>
      <textarea id="suggestion" rows="6" placeholder="è«‹è©³ç´°è¼¸å…¥æ‚¨çš„å»ºè­°å…§å®¹..."></textarea>

      <label>6. å…·é«”äº‹è­‰ / å»ºè­°æ–¹æ¡ˆ <span class="required">*</span></label>
      <textarea id="evidence" rows="4" placeholder="è«‹åˆ—å‡ºå…·é«”æ•¸æ“šæˆ–è§£æ±ºæ–¹æ¡ˆï¼ˆå¿…å¡«ï¼‰"></textarea>

      <!-- AI æ¯”å°çµæœ (é è¨­éš±è—) -->
      <div class="hint" id="dupHint">
        <div class="hint-title">ğŸ”” æ­·æ¬¡åº§è«‡æœƒç›¸é—œç´€éŒ„æª¢ç´¢çµæœ</div>
        <div id="aiSummary" class="hint-text">æ­£åœ¨èª¿é–±æª”æ¡ˆåº«...</div>
        <div id="historyTable"></div>
        
        <!-- ç¬¬ä¸€éšæ®µæ±ºç­– -->
        <div id="decisionZone" style="margin-top:25px; display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
            <button class="btn btnSuccess" onclick="window.location.reload()">ğŸ‘Œ æˆ‘å·²äº†è§£ï¼Œå–æ¶ˆæœ¬æ¬¡æäº¤</button>
            <button class="btn btnDanger" onclick="triggerAlertSequence()">å…§å®¹ä¸åŒï¼Œå …æŒé€å‡ºå»ºè­°</button>
        </div>
      </div>

      <!-- æœ€çµ‚ç¢ºèªæ¡† (å„ªå…ˆå¼•å°æ”¾æ£„) -->
      <div id="finalConfirmCard">
          <div style="font-size:30px; font-weight:700; color:#d63031; margin-bottom:20px;">ğŸ“¢ æœ€å¾Œç¢ºèª</div>
          <p style="font-size:20px; margin-bottom:30px; color:#444;">ç³»çµ±æ¯”å°ç™¼ç¾å·²æœ‰é«˜åº¦ç›¸ä¼¼çš„æ­·å¹´ç´€éŒ„ã€‚<br>å»ºè­°æ‚¨åƒé–±è¾¦ç†çµæœï¼Œé¿å…é‡è¤‡ææ¡ˆã€‚</p>
          
          <!-- å„ªå…ˆé¸é …ï¼šæ”¾æ£„ (å¤§æŒ‰éˆ•) -->
          <button class="btn btn-giveup" onclick="window.location.reload()">âœ… äº†è§£ï¼Œæˆ‘ä¸é€å‡ºäº†</button>
          
          <div style="margin-top:15px; color:#7f8c8d; font-size:16px;">
             è‹¥æ‚¨ç¢ºå®šé€™æ˜¯æ–°æ¡ˆï¼Œè«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼š<br>
             <!-- å¾Œå‚™é¸é …ï¼šå …æŒé€å‡º (å°é€£çµ/æŒ‰éˆ•) -->
             <button class="btn btn-force" onclick="finalSave()">âš ï¸ æˆ‘å·²ç¢ºèªç„¡èª¤ï¼Œæ­£å¼å­˜æª”</button>
          </div>
      </div>

      <button class="btn btnPrimary" id="submitBtn" onclick="handleInitialSubmit()">ğŸ’Œ é€å‡ºå»ºè­°äº‹é …</button>
    </section>

    <section class="success" id="successBox">
      <div style="font-size: 80px; margin-bottom: 20px;">ğŸ‰</div>
      <h3>æäº¤æˆåŠŸï¼æ„Ÿè¬åƒèˆ‡</h3>
      <p style="font-size:20px; margin:20px 0;">æ‚¨çš„å»ºè­°å·²å­˜å…¥ç³»çµ±ï¼Œæˆ‘å€‘å°‡èªçœŸç ”è­°ã€‚ğŸ’š</p>
      <img src="./1769910482662.jpg" style="width:100%; max-width:600px; border-radius:20px; margin-top:30px;">
    </section>
  </main>

  <script>
    // è«‹ç¢ºèªæ­¤è™•ç¶²å€æ­£ç¢º
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzkVW4Fna1S2s38oWelc26FaoEUCE8UUoZHYlq00KGUTLBZ-VbHPavnjtCj1lCZG45i/exec";
    
    document.getElementById('today').textContent = `ğŸ“… ${new Date().toLocaleDateString('zh-TW', {year:'numeric', month:'2-digit', day:'2-digit'})}`;

    function toggleId(s) { document.getElementById('identitySection').style.display = s ? 'block' : 'none'; }

    // 1. æ¶ˆé˜²è»ŠéŸ³æ•ˆ (Web Audio API - æ¨¡æ“¬é•·é³´è­¦ç¬›)
    function playFireSiren() {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      
      osc.type = "sawtooth"; // é‹¸é½’æ³¢ï¼Œè²éŸ³è¼ƒæœ‰ç©¿é€åŠ›
      osc.connect(gain);
      gain.connect(ctx.destination);
      
      const now = ctx.currentTime;
      // æ¨¡æ“¬æ¶ˆé˜²è»Š/æ•‘è­·è»Šçš„é«˜ä½éŸ³é »åˆ‡æ› (Low-High-Low)
      osc.frequency.setValueAtTime(600, now);
      osc.frequency.linearRampToValueAtTime(1200, now + 0.6); // å‡é »
      osc.frequency.linearRampToValueAtTime(600, now + 1.2);  // é™é »
      
      // éŸ³é‡å¤§ä¸€é»
      gain.gain.setValueAtTime(0.5, now);
      
      osc.start(now);
      osc.stop(now + 1.2); // æ’­æ”¾ 1.2 ç§’
    }

    // 2. è§¸ç™¼è­¦ç¤ºæµç¨‹ (é€£çºŒå…©æ¬¡è­¦ç¬›)
    function triggerAlertSequence() {
      const overlay = document.getElementById('sirenOverlay');
      overlay.classList.add('siren-active'); // é–‹å§‹é–ƒçˆ
      
      playFireSiren();
      setTimeout(playFireSiren, 1300); // 1.3ç§’å¾Œå†éŸ¿ä¸€æ¬¡

      // 3ç§’å¾Œåœæ­¢é–ƒçˆï¼Œè·³å‡ºæœ€çµ‚ç¢ºèª
      setTimeout(() => {
        overlay.classList.remove('siren-active');
        document.getElementById('decisionZone').style.display = 'none';
        document.getElementById('finalConfirmCard').style.display = 'block';
        window.scrollTo({ top: document.getElementById('finalConfirmCard').offsetTop - 50, behavior: 'smooth' });
      }, 3000);
    }

    // 3. ç¬¬ä¸€éšæ®µï¼šé€å‡ºæ¯”å°
    async function handleInitialSubmit() {
      const q = document.getElementById('suggestion').value.trim();
      const e = document.getElementById('evidence').value.trim();
      
      if (!q || !e) return alert("ã€Œå»ºè­°äº‹é …ã€èˆ‡ã€Œå…·é«”äº‹è­‰ã€çš†ç‚ºå¿…å¡«é …ç›®ã€‚");

      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.innerText = "ğŸ” æ­£åœ¨æœå°‹æ­·å²ç´€éŒ„...";

      document.getElementById('loadingOverlay').style.display = 'flex';

      try {
        const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "query", query: q }) });
        const json = await res.json();
        
        document.getElementById('loadingOverlay').style.display = 'none';

        if (json.status === "success") {
          if (json.data.history && json.data.history.length > 0) {
            // æœ‰é‡è¤‡ï¼šé¡¯ç¤ºæ¯”å°çµæœ
            document.getElementById('dupHint').style.display = 'block';
            document.getElementById('aiSummary').innerText = json.data.summary;
            
            let h = '<table class="history-table"><thead><tr><th>æ—¥æœŸ</th><th>è¨´æ±‚æ‘˜è¦</th><th>è¾¦ç†çµæœ</th></tr></thead><tbody>';
            json.data.history.forEach(item => {
              h += `<tr><td>${item.date}</td><td>${item.proposal}</td><td>${item.conclusion}</td></tr>`;
            });
            document.getElementById('historyTable').innerHTML = h + '</tbody></table>';
            
            document.getElementById('submitBtn').style.display = 'none';
            window.scrollTo({ top: document.getElementById('dupHint').offsetTop - 50, behavior: 'smooth' });
          } else {
            // ç„¡é‡è¤‡ï¼šç›´æ¥å­˜æª”
            await finalSave();
          }
        }
      } catch (err) {
        document.getElementById('loadingOverlay').style.display = 'none';
        alert("é€£ç·šç•°å¸¸ï¼Œè«‹é‡è©¦");
        btn.disabled = false;
        btn.innerText = "ğŸ’Œ é€å‡ºå»ºè­°äº‹é …";
      }
    }

    // 4. æœ€çµ‚å­˜æª”
    async function finalSave() {
      document.getElementById('finalConfirmCard').style.display = 'none';
      document.getElementById('loadingOverlay').style.display = 'flex';

      const formData = {
        identity: document.querySelector('input[name="identity"]:checked').value,
        dept: document.getElementById('dept').value,
        jobTitle: document.getElementById('jobTitle').value,
        userName: document.getElementById('userName').value,
        suggestion: document.getElementById('suggestion').value,
        evidence: document.getElementById('evidence').value
      };

      try {
        const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "save", formData: formData }) });
        const json = await res.json();
        document.getElementById('loadingOverlay').style.display = 'none';
        
        if (json.status === "success") {
          document.getElementById('formSection').style.display = 'none';
          document.getElementById('successBox').style.display = 'block';
          window.scrollTo(0,0);
        }
      } catch (e) {
        document.getElementById('loadingOverlay').style.display = 'none';
        alert("å­˜æª”å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚");
      }
    }
  </script>
</body>
</html>
